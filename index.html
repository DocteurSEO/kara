<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TikTok Lyrics Creator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap');

        :root {
            --primary: #ffffff;
            --shadow: rgba(0, 0, 0, 0.8);
        }

        body {
            margin: 0;
            background: #000;
            color: white;
            font-family: 'Montserrat', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Cadre simulation t√©l√©phone */
        #phone-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: #000;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        @media (min-width: 768px) {
            #phone-wrapper {
                width: 45vh; /* Ratio 9:16 */
                height: 90vh;
                border-radius: 30px;
                border: 4px solid #222;
            }
        }

        /* --- COUCHES (LAYERS) --- */
        #bg-video-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            opacity: 0.6; /* Assombrir l√©g√®rement pour la lisibilit√© */
        }

        #particle-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* --- TYPOGRAPHIE --- */
        .lyrics-container {
            padding: 0 15%; /* Marges lat√©rales */
            text-align: center;
            /* Positionnement Safe Zone TikTok */
            margin-top: -10%; 
        }

        #line {
            font-size: clamp(1.2rem, 3.5vh, 1.8rem); /* Plus petit, plus √©l√©gant */
            font-weight: 800;
            line-height: 1.4;
            color: white;
            text-shadow: 0 2px 10px var(--shadow);
            transition: transform 0.1s;
        }

        .word-span {
            display: inline-block;
            opacity: 0;
            transform: translateY(15px);
            filter: blur(4px);
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            margin: 0 3px;
        }

        .word-visible {
            opacity: 1;
            transform: translateY(0);
            filter: blur(0);
        }

        .word-highlight {
            color: var(--primary);
            text-shadow: 0 0 15px var(--primary);
        }

        /* --- UI SETUP --- */
        #setup-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111;
            z-index: 50;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .input-card {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
        }
        .input-card:active { transform: scale(0.98); background: #222; }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--primary);
            width: 0%;
            z-index: 100;
            opacity: 0.7;
        }

        /* Wave en bas */
        #waveCanvas {
            position: absolute;
            bottom: 50px; /* Un peu au dessus du bas */
            left: 0;
            width: 100%;
            height: 100px;
            z-index: 5;
            opacity: 0.8;
            pointer-events: none;
        }
        
        .hint-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>

<div id="phone-wrapper">
    
    <!-- ARRI√àRE-PLAN VID√âO (Optionnel) -->
    <video id="bg-video-layer" loop muted playsinline class="hidden"></video>
    
    <!-- PARTICULES -->
    <canvas id="particle-canvas"></canvas>

    <!-- UI LAYER (Lyrics) -->
    <div id="ui-layer" style="display:none;">
        <div class="progress-bar" id="progress"></div>
        <div class="lyrics-container">
            <div id="line"></div>
        </div>
        <canvas id="waveCanvas"></canvas>
        <div class="hint-overlay" id="hint">Tap: Pause ‚Ä¢ Double Tap: Replay</div>
    </div>

    <!-- SETUP SCREEN -->
    <div id="setup-screen">
        <h1 class="text-3xl font-black italic mb-6 text-center tracking-tighter">CREATOR <span class="text-purple-500">STUDIO</span></h1>
        
        <label class="input-card">
            <span class="text-xl">üéµ</span>
            <div class="flex-1">
                <div class="text-[10px] text-gray-400 uppercase font-bold">√âtape 1</div>
                <div class="text-sm font-bold text-gray-200 truncate" id="audioLabel">Choisir la musique</div>
            </div>
            <input type="file" id="audioInput" accept="audio/*" class="hidden">
        </label>

        <label class="input-card">
            <span class="text-xl">üìù</span>
            <div class="flex-1">
                <div class="text-[10px] text-gray-400 uppercase font-bold">√âtape 2</div>
                <div class="text-sm font-bold text-gray-200 truncate" id="srtLabel">Fichier SRT</div>
            </div>
            <input type="file" id="srtInput" accept=".srt" class="hidden">
        </label>

        <label class="input-card" style="border-color: #444; background: #222;">
            <span class="text-xl">üé•</span>
            <div class="flex-1">
                <div class="text-[10px] text-gray-400 uppercase font-bold">Optionnel</div>
                <div class="text-sm font-bold text-gray-200 truncate" id="videoLabel">Fond Vid√©o (mp4)</div>
            </div>
            <input type="file" id="videoInput" accept="video/*" class="hidden">
        </label>

        <button id="aiBtn" class="mt-2 py-3 border border-purple-500/30 text-purple-400 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-purple-500/10 transition-colors flex justify-center items-center gap-2">
            ‚ú® Auto-Color (Gemini AI)
        </button>

        <button id="startBtn" class="mt-6 bg-white text-black py-4 rounded-xl font-black text-lg shadow-xl active:scale-95 transition-transform">
            COMMENCER
        </button>
    </div>

</div>

<audio id="audio"></audio>

<script>
    // DOM Elements
    const setupScreen = document.getElementById('setup-screen');
    const uiLayer = document.getElementById('ui-layer');
    const bgVideo = document.getElementById('bg-video-layer');
    const audio = document.getElementById('audio');
    const lineEl = document.getElementById('line');
    const progress = document.getElementById('progress');
    const hint = document.getElementById('hint');
    
    // Inputs
    const audioInput = document.getElementById('audioInput');
    const srtInput = document.getElementById('srtInput');
    const videoInput = document.getElementById('videoInput');
    
    // Buttons
    const startBtn = document.getElementById('startBtn');
    const aiBtn = document.getElementById('aiBtn');

    // Contexts
    let audioCtx, analyser, dataArray;
    let particleCtx, waveCtx;
    let particles = [];
    let subtitles = [];
    let lastSubIndex = -1;
    let isPlaying = false;
    let animationId;

    // Config Visuelle
    let config = {
        color: "#a855f7", // Purple par d√©faut
        particleCount: 40,
        mood: "chill"
    };

    const apiKey = ""; // API Key inject√©e

    // --- INPUT HANDLERS ---
    audioInput.onchange = (e) => document.getElementById('audioLabel').innerText = e.target.files[0]?.name || "Choisir la musique";
    srtInput.onchange = (e) => document.getElementById('srtLabel').innerText = e.target.files[0]?.name || "Fichier SRT";
    videoInput.onchange = (e) => {
        const file = e.target.files[0];
        if(file) {
            document.getElementById('videoLabel').innerText = file.name;
            bgVideo.src = URL.createObjectURL(file);
            bgVideo.classList.remove('hidden');
        }
    };

    // --- PARSING SRT ---
    function parseSRT(data) {
        return data.replace(/\r/g, "").split("\n\n").map(block => {
            const lines = block.split("\n");
            if (lines.length >= 3) {
                const timeMatch = lines[1].match(/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/);
                if (timeMatch) {
                    const toSec = t => {
                        const [h, m, s] = t.replace(",", ".").split(":");
                        return (+h * 3600) + (+m * 60) + (+s);
                    };
                    return {
                        start: toSec(timeMatch[1]),
                        end: toSec(timeMatch[2]),
                        text: lines.slice(2).join(" ").trim()
                    };
                }
            }
            return null;
        }).filter(Boolean);
    }

    // --- GEMINI AI COLOR ---
    aiBtn.onclick = async () => {
        if(!srtInput.files[0]) return alert("Il faut le fichier SRT d'abord !");
        
        aiBtn.innerHTML = "‚è≥ Analyse...";
        const text = await srtInput.files[0].text();
        
        try {
            const prompt = `Analyse ces paroles. Donne moi une couleur Hexad√©cimale qui correspond √† l'√©motion. R√©ponds juste avec le code JSON: {"hex": "#RRGGBB"}. Paroles: ${text.substring(0,300)}`;
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
            });
            const data = await response.json();
            const res = JSON.parse(data.candidates[0].content.parts[0].text);
            
            config.color = res.hex;
            document.documentElement.style.setProperty('--primary', config.color);
            aiBtn.innerHTML = `üé® Couleur d√©finie !`;
            aiBtn.style.borderColor = config.color;
            aiBtn.style.color = config.color;
        } catch(e) {
            aiBtn.innerHTML = "‚ùå Erreur (D√©faut)";
        }
    };

    // --- PARTICULES SYSTEM ---
    class Particle {
        constructor(w, h) {
            this.w = w; this.h = h;
            this.reset();
        }
        reset() {
            this.x = Math.random() * this.w;
            this.y = Math.random() * this.h;
            this.size = Math.random() * 2;
            this.speedY = Math.random() * 0.5 + 0.1;
            this.opacity = Math.random() * 0.5;
        }
        update() {
            this.y -= this.speedY; // Monte doucement
            if(this.y < 0) this.reset();
        }
        draw(ctx) {
            ctx.fillStyle = config.color;
            ctx.globalAlpha = this.opacity;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;
        }
    }

    function initParticles() {
        const cvs = document.getElementById('particle-canvas');
        particleCtx = cvs.getContext('2d');
        const updateSize = () => {
            cvs.width = cvs.offsetWidth;
            cvs.height = cvs.offsetHeight;
            particles = Array(config.particleCount).fill().map(() => new Particle(cvs.width, cvs.height));
        };
        window.onresize = updateSize;
        updateSize();
    }

    // --- MAIN RENDER LOOP ---
    function render() {
        animationId = requestAnimationFrame(render);
        
        // 1. Audio Data
        analyser.getByteFrequencyData(dataArray);
        const bass = dataArray[2]; // Basse fr√©quence

        // 2. Particules
        particleCtx.clearRect(0, 0, particleCtx.canvas.width, particleCtx.canvas.height);
        particles.forEach(p => {
            p.update();
            p.draw(particleCtx);
        });

        // 3. Waveform (Subtil en bas)
        const wCvs = document.getElementById('waveCanvas');
        if(!waveCtx) waveCtx = wCvs.getContext('2d');
        if(wCvs.width !== wCvs.offsetWidth) {
            wCvs.width = wCvs.offsetWidth;
            wCvs.height = wCvs.offsetHeight;
        }
        
        waveCtx.clearRect(0, 0, wCvs.width, wCvs.height);
        waveCtx.beginPath();
        waveCtx.moveTo(0, wCvs.height);
        const slice = wCvs.width / dataArray.length;
        let x = 0;
        for(let i=0; i<dataArray.length; i++) {
            const v = dataArray[i] / 128.0;
            const y = wCvs.height - (v * 30); // Hauteur max 30px
            if(i===0) waveCtx.moveTo(x,y);
            else waveCtx.lineTo(x,y);
            x += slice;
        }
        waveCtx.strokeStyle = config.color;
        waveCtx.lineWidth = 2;
        waveCtx.stroke();

        // 4. Bass Kick effect on Text
        if(bass > 220) {
            lineEl.style.transform = `scale(1.05)`;
            lineEl.style.textShadow = `0 0 20px ${config.color}`;
        } else {
            lineEl.style.transform = `scale(1)`;
            lineEl.style.textShadow = `0 2px 10px rgba(0,0,0,0.8)`;
        }
    }

    // --- START LOGIC ---
    startBtn.onclick = async () => {
        if(!audioInput.files[0] || !srtInput.files[0]) return alert("Fichiers manquants !");
        
        // Setup Audio
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        const src = audioCtx.createMediaElementSource(audio);
        src.connect(analyser);
        analyser.connect(audioCtx.destination);
        analyser.fftSize = 64; // Moins de barres pour performance
        dataArray = new Uint8Array(analyser.frequencyBinCount);

        // Load Content
        subtitles = parseSRT(await srtInput.files[0].text());
        audio.src = URL.createObjectURL(audioInput.files[0]);
        if(videoInput.files[0]) bgVideo.play();

        // UI Switch
        setupScreen.style.display = 'none';
        uiLayer.style.display = 'flex';
        initParticles();

        // Play
        audio.play();
        bgVideo.play().catch(e => {}); // Au cas o√π pas de vid√©o
        isPlaying = true;
        render();

        // Show Hint temporarily
        hint.style.opacity = 1;
        setTimeout(() => hint.style.opacity = 0, 3000);
    };

    // --- SYNC & CONTROLS ---
    audio.ontimeupdate = () => {
        const t = audio.currentTime;
        progress.style.width = (t / audio.duration * 100) + "%";

        const index = subtitles.findIndex(s => t >= s.start && t <= s.end);
        if(index !== -1 && index !== lastSubIndex) {
            lastSubIndex = index;
            // Animation Mot par Mot propre
            lineEl.innerHTML = "";
            const words = subtitles[index].text.split(" ");
            words.forEach((w, i) => {
                const s = document.createElement('span');
                s.innerText = w;
                s.className = 'word-span';
                if(Math.random() > 0.7) s.classList.add('word-highlight'); // Random highlight
                lineEl.appendChild(s);
                setTimeout(() => s.classList.add('word-visible'), i * 50);
            });
        } else if (index === -1) {
            // Optionnel : Effacer ou garder le dernier texte
        }
    };

    // Touch Controls
    const wrapper = document.getElementById('phone-wrapper');
    let lastTap = 0;
    
    wrapper.onclick = (e) => {
        const now = new Date().getTime();
        const tapLen = now - lastTap;
        
        if (tapLen < 300 && tapLen > 0) {
            // Double Tap -> Replay
            audio.currentTime = 0;
            if(!isPlaying) audio.play();
            lastSubIndex = -1;
            lineEl.innerHTML = "";
        } else {
            // Single Tap -> Pause/Play
            // Petit d√©lai pour v√©rifier si c'est un double tap
            setTimeout(() => {
                if (new Date().getTime() - lastTap >= 300) {
                     if(isPlaying) {
                        audio.pause();
                        if(bgVideo.src) bgVideo.pause();
                        isPlaying = false;
                        hint.innerText = "Pause";
                        hint.style.opacity = 1;
                    } else {
                        audio.play();
                        if(bgVideo.src) bgVideo.play();
                        isPlaying = true;
                        hint.style.opacity = 0;
                    }
                }
            }, 300);
        }
        lastTap = now;
    };

</script>
</body>
</html>