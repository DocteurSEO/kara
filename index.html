<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TikTok Lyrics Creator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Outfit:wght@400;700;900&display=swap');

        :root {
            --primary: #a855f7;
            --bg: #000000;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: white;
            font-family: 'Outfit', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            -webkit-font-smoothing: antialiased;
        }

        #phone-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        @media (min-width: 768px) {
            #phone-wrapper {
                width: 42vh;
                height: 88vh;
                border-radius: 40px;
                border: 6px solid #1a1a1a;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            }
        }

        /* LAYERS */
        #bg-layer-video {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            opacity: 0.5;
        }

        #particle-canvas {
            position: absolute;
            inset: 0;
            z-index: 1;
            pointer-events: none;
        }

        #ui-layer {
            position: absolute;
            inset: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        /* --- VISUALIZERS --- */
        #wave-canvas {
            position: absolute;
            bottom: 40px;
            left: 0;
            width: 100%;
            height: 100px;
            z-index: 2;
            pointer-events: none;
            opacity: 0.6;
        }

        /* --- LYRICS STAGES --- */
        .lyrics-stage {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
        }

        /* ANIMATION: SCROLL */
        .scroll-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50vh;
            padding-bottom: 50vh;
        }

        .scroll-word {
            font-size: 1.5rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.4);
            margin: 8px 0;
            transition: color 0.1s;
            text-align: center;
        }

        .scroll-word.active {
            color: #fff;
            font-size: 2.2rem;
            text-shadow: 0 0 20px var(--primary);
            transform: scale(1.1);
        }

        /* ANIMATION: FOCUS */
        .focus-container {
            width: 100%;
            text-align: center;
            padding: 20px;
        }

        .focus-word {
            display: inline-block;
            font-weight: 900;
            line-height: 1;
        }

        /* ANIMATION: CLASSIC */
        .classic-container {
            position: absolute;
            bottom: 15%;
            width: 100%;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }

        .classic-word {
            font-size: 1.5rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.5);
        }

        .classic-word.active {
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary);
            transform: scale(1.05);
        }

        /* SETUP & UTILS */
        #setup-screen {
            position: absolute;
            inset: 0;
            background: rgba(10, 10, 10, 0.98);
            z-index: 50;
            padding: 24px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-bar {
            height: 4px;
            background: var(--primary);
            width: 0%;
        }
    </style>
</head>

<body>

    <div id="phone-wrapper">
        <video id="bg-layer-video" loop muted playsinline class="hidden"></video>
        <canvas id="particle-canvas"></canvas>

        <div id="ui-layer" style="display:none;">
            <div id="lyrics-stage" class="lyrics-stage"></div>
            <canvas id="wave-canvas"></canvas> <!-- RESTORATION -->
            <div class="progress-bar" id="progress"></div>
        </div>

        <!-- SETUP -->
        <div id="setup-screen">
            <h1 class="text-4xl font-black italic mb-8 text-center text-white">KARA<span
                    class="text-purple-500">GEN</span></h1>

            <label class="glass-panel">
                <span class="text-2xl">üéµ</span>
                <div class="flex-1 overflow-hidden">
                    <div class="text-[10px] uppercase text-gray-400 font-bold">Audio</div>
                    <div id="label-audio" class="truncate font-bold text-sm">Choisir Fichier</div>
                </div>
                <input type="file" id="input-audio" accept="audio/*" class="hidden">
            </label>

            <label class="glass-panel">
                <span class="text-2xl">üìù</span>
                <div class="flex-1 overflow-hidden">
                    <div class="text-[10px] uppercase text-gray-400 font-bold">Paroles</div>
                    <div id="label-json" class="truncate font-bold text-sm">Fichier JSON</div>
                </div>
                <input type="file" id="input-json" accept=".json,.srt" class="hidden">
            </label>

            <label class="glass-panel">
                <span class="text-2xl">‚ú®</span>
                <div class="flex-1">
                    <div class="text-[10px] uppercase text-gray-400 font-bold">Animation</div>
                    <select id="select-animation" class="bg-transparent w-full font-bold outline-none text-purple-400">
                        <option value="scroll">üìú Scroll (Liste D√©filante)</option>
                        <option value="focus">üéØ Focus (Big Single)</option>
                        <option value="classic">üé§ Classic (Sous-titres)</option>
                    </select>
                </div>
            </label>

            <label class="glass-panel">
                <span class="text-2xl">üé•</span>
                <div class="flex-1 overflow-hidden">
                    <div class="text-[10px] uppercase text-gray-400 font-bold">Vid√©o (Optionnel)</div>
                    <div id="label-video" class="truncate font-bold text-sm">Aucune vid√©o</div>
                </div>
                <input type="file" id="input-video" accept="video/*" class="hidden">
            </label>

            <button id="btn-start"
                class="mt-4 bg-purple-600 w-full py-4 rounded-xl font-bold text-lg shadow-lg">START</button>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script>
        // --- STATE ---
        const state = {
            words: [],
            isPlaying: false,
            mode: 'scroll',
            domElements: [],
            audioCtx: null,
            analyser: null,
            dataArray: null
        };

        const ui = {
            stage: document.getElementById('lyrics-stage'),
            inputs: {
                audio: document.getElementById('input-audio'),
                json: document.getElementById('input-json'),
                video: document.getElementById('input-video'),
                anim: document.getElementById('select-animation')
            },
            labels: {
                audio: document.getElementById('label-audio'),
                json: document.getElementById('label-json'),
                video: document.getElementById('label-video')
            },
            video: document.getElementById('bg-layer-video'),
            audio: document.getElementById('audio-player'),
            setup: document.getElementById('setup-screen'),
            app: document.getElementById('ui-layer'),
            progress: document.getElementById('progress')
        };

        // --- ENGINES ---
        const Engines = {
            scroll: {
                init: (container, words) => {
                    container.className = 'lyrics-stage flex-col';
                    container.innerHTML = '<div id="scroll-wrapper" class="scroll-container"></div>';
                    const wrapper = document.getElementById('scroll-wrapper');
                    state.domElements = [];
                    words.forEach((w, i) => {
                        const el = document.createElement('div');
                        el.innerText = w.text;
                        el.className = 'scroll-word';
                        el.dataset.index = i;
                        wrapper.appendChild(el);
                        state.domElements.push(el);
                    });
                },
                update: (time, words) => {
                    const activeIdx = words.findIndex(w => time >= w.start && time <= w.end);
                    let targetIdx = activeIdx;
                    if (targetIdx === -1) targetIdx = words.findIndex(w => w.start > time) - 1;
                    if (targetIdx < 0) targetIdx = 0;

                    const wrapper = document.getElementById('scroll-wrapper');
                    state.domElements.forEach((el, i) => {
                        if (i === activeIdx) el.classList.add('active');
                        else el.classList.remove('active');

                        const dist = Math.abs(i - targetIdx);
                        el.style.opacity = dist > 4 ? 0.1 : 1 - (dist * 0.15);
                    });

                    const targetEl = state.domElements[targetIdx];
                    if (targetEl) {
                        const itemY = targetEl.offsetTop;
                        const itemH = targetEl.offsetHeight;
                        const stageH = ui.stage.offsetHeight;
                        const desiredY = (stageH / 2) - (itemY + itemH / 2);
                        gsap.to(wrapper, { y: desiredY, duration: 0.5, ease: "power2.out" });
                    }
                }
            },
            focus: {
                init: (container) => {
                    container.innerHTML = '<div id="focus-wrapper" class="focus-container"></div>';
                },
                update: (time, words) => {
                    const activeIdx = words.findIndex(w => time >= w.start && time <= w.end);
                    const wrapper = document.getElementById('focus-wrapper');
                    if (activeIdx !== -1 && state.lastRenderedIdx !== activeIdx) {
                        state.lastRenderedIdx = activeIdx;
                        const w = words[activeIdx];
                        wrapper.innerHTML = '';
                        const el = document.createElement('div');
                        el.innerText = w.text;
                        const len = w.text.length;
                        const size = len < 5 ? '5rem' : len < 10 ? '3.5rem' : '2.5rem';
                        el.className = 'focus-word';
                        el.style.fontSize = size;
                        el.style.color = '#fff';
                        el.style.textShadow = '0 0 30px var(--primary)';
                        wrapper.appendChild(el);
                        gsap.fromTo(el, { scale: 0.5, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.3, ease: 'back.out(1.5)' });
                    }
                }
            },
            classic: {
                init: (container) => {
                    container.innerHTML = '<div id="classic-wrapper" class="classic-container"></div>';
                },
                update: (time, words) => {
                    const activeIdx = words.findIndex(w => time >= w.start && time <= w.end);
                    let centerIdx = activeIdx;
                    if (centerIdx === -1) centerIdx = words.findIndex(w => w.start > time) - 1;
                    if (centerIdx < 0) centerIdx = 0;

                    if (state.lastRenderedIdx === centerIdx && activeIdx === state.lastCheckActive) return;
                    state.lastRenderedIdx = centerIdx;
                    state.lastCheckActive = activeIdx;

                    const wrapper = document.getElementById('classic-wrapper');
                    wrapper.innerHTML = '';
                    const start = Math.max(0, centerIdx - 2);
                    const end = Math.min(words.length, centerIdx + 5);

                    for (let i = start; i < end; i++) {
                        const w = words[i];
                        const el = document.createElement('span');
                        el.innerText = w.text;
                        el.className = 'classic-word';
                        if (i === activeIdx) el.classList.add('active');
                        wrapper.appendChild(el);
                    }
                }
            }
        };

        // --- PARSERS ---
        function parseContent(text, isJson) {
            if (isJson) {
                try {
                    const json = JSON.parse(text);
                    const segments = json.segments || json;
                    return segments.flatMap(s => (s.words || []).map(w => ({
                        text: w.text, start: w.start_time || w.start, end: w.end_time || w.end
                    })));
                } catch (e) { return parseSRT(text); }
            }
            return parseSRT(text);
        }

        function parseSRT(data) {
            return data.replace(/\r/g, "").split("\n\n").map(block => {
                const parts = block.split("\n");
                if (parts.length >= 3) {
                    const timeMatch = parts[1].match(/(\d{2}:\d{2}:\d{2},\d{3}) -->(\d{ 2}: \d{ 2}: \d{ 2}, \d{ 3}) /);
                    if (timeMatch) {
                        const toSec = t => {
                            const [h, m, s] = t.replace(",", ".").split(":");
                            return (+h * 3600) + (+m * 60) + (+s);
                        };
                        const start = toSec(timeMatch[1]);
                        const end = toSec(timeMatch[2]);
                        const text = parts.slice(2).join(" ").trim();
                        const words = text.split(" ");
                        const dur = (end - start) / words.length;
                        return words.map((w, i) => ({ text: w, start: start + i * dur, end: start + (i + 1) * dur }));
                    }
                }
                return [];
            }).flat();
        }

        // --- AUDIO & VISUALS ---
        function initAudio() {
            state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            state.analyser = state.audioCtx.createAnalyser();
            const src = state.audioCtx.createMediaElementSource(ui.audio);
            src.connect(state.analyser);
            state.analyser.connect(state.audioCtx.destination);
            state.analyser.fftSize = 256;
            state.dataArray = new Uint8Array(state.analyser.frequencyBinCount);
        }

        let particles = [];
        function initVisuals() {
            const pc = document.getElementById('particle-canvas');
            const pCtx = pc.getContext('2d');
            const wc = document.getElementById('wave-canvas');
            const wCtx = wc.getContext('2d');

            const resize = () => {
                pc.width = window.innerWidth; pc.height = window.innerHeight;
                wc.width = wc.offsetWidth; wc.height = wc.offsetHeight;
            };
            window.onresize = resize;
            resize();

            particles = Array(40).fill().map(() => ({
                x: Math.random() * pc.width,
                y: Math.random() * pc.height,
                size: Math.random() * 3,
                speed: Math.random() * 0.5 + 0.2
            }));

            return { pCtx, wCtx, pc, wc };
        }

        let vizCtx;

        // --- LOOP ---
        function loop() {
            requestAnimationFrame(loop);

            if (state.isPlaying) {
                const time = ui.audio.currentTime;
                ui.progress.style.width = (time / ui.audio.duration * 100) + "%";

                // Audio Data
                state.analyser.getByteFrequencyData(state.dataArray);
                const bass = state.dataArray[2];

                // 1. Lyrics Update
                const engine = Engines[state.mode];
                if (engine) engine.update(time, state.words);

                // 2. Visuals Update
                if (vizCtx) {
                    // Particles
                    vizCtx.pCtx.clearRect(0, 0, vizCtx.pc.width, vizCtx.pc.height);
                    particles.forEach(p => {
                        p.y -= p.speed * (1 + bass / 100); // Reactive Speed
                        if (p.y < 0) p.y = vizCtx.pc.height;
                        vizCtx.pCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                        vizCtx.pCtx.beginPath();
                        vizCtx.pCtx.arc(p.x, p.y, p.size * (1 + bass / 200), 0, Math.PI * 2); // Reactive Size
                        vizCtx.pCtx.fill();
                    });

                    // Waveform
                    const w = vizCtx.wc.width;
                    const h = vizCtx.wc.height;
                    vizCtx.wCtx.clearRect(0, 0, w, h);
                    vizCtx.wCtx.beginPath();
                    const sliceWidth = w / state.dataArray.length;
                    let x = 0;
                    for (let i = 0; i < state.dataArray.length; i++) {
                        const v = state.dataArray[i] / 255.0;
                        const y = h - (v * h);
                        if (i === 0) vizCtx.wCtx.moveTo(x, y);
                        else vizCtx.wCtx.lineTo(x, y);
                        x += sliceWidth;
                    }
                    vizCtx.wCtx.strokeStyle = 'rgba(168, 85, 247, 0.5)'; // Primary color
                    vizCtx.wCtx.lineWidth = 2;
                    vizCtx.wCtx.stroke();
                }
            }
        }

        // --- EVENTS ---
        ui.inputs.audio.onchange = (e) => ui.labels.audio.innerText = e.target.files[0]?.name || "...";
        ui.inputs.json.onchange = (e) => ui.labels.json.innerText = e.target.files[0]?.name || "...";
        ui.inputs.video.onchange = (e) => {
            const f = e.target.files[0];
            if (f) {
                ui.video.src = URL.createObjectURL(f);
                ui.video.classList.remove('hidden');
                ui.labels.video.innerText = f.name;
            }
        };

        document.getElementById('btn-start').onclick = async () => {
            const fa = ui.inputs.audio.files[0];
            const fj = ui.inputs.json.files[0];
            if (!fa || !fj) return alert("Fichier manquant");

            state.mode = ui.inputs.anim.value;
            const text = await fj.text();
            state.words = parseContent(text, fj.name.endsWith('.json'));

            ui.audio.src = URL.createObjectURL(fa);
            if (ui.video.src) ui.video.play();

            ui.setup.style.display = 'none';
            ui.app.style.display = 'flex';

            initAudio();
            vizCtx = initVisuals();

            if (Engines[state.mode].init) Engines[state.mode].init(ui.stage, state.words);

            ui.audio.play();
            state.isPlaying = true;
            loop();
        };
    </script>
</body>

</html>